"use client";

import { useState, useEffect, useCallback } from "react";
import { useTranslations } from "next-intl";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { cn } from "@/lib/utils";
import { RefreshCw, CheckCircle2, XCircle, Trophy, Target, AlertTriangle } from "lucide-react";
import { useQuizProgressStore } from "@/stores/quizProgressStore";
import { useAuthStore } from "@/stores/authStore";

// Exploit Quiz Questions - Adjusting GTO strategy based on opponent types
const EXPLOIT_QUESTIONS = [
  // Station (Calling Station)
  {
    id: "station_1",
    category: "station",
    categoryZh: "跟注站",
    categoryEn: "Calling Station",
    difficulty: "medium",
    question:
      "面對一位「跟注站」型對手，你持有 ATs 在 BTN 開牌後被 BB 3bet。GTO 建議以一定頻率 4bet bluff，你應該如何調整？",
    questionEn:
      "Against a 'Calling Station' opponent, you have ATs on BTN and face a BB 3bet. GTO suggests 4bet bluffing at some frequency. How should you adjust?",
    options: [
      {
        key: "a",
        text: "改為直接棄牌 - 跟注站不會棄牌，4bet bluff 沒有 fold equity",
        textEn: "Fold instead - Stations don't fold, 4bet bluff has no fold equity",
      },
      {
        key: "b",
        text: "維持 GTO 頻率 - 對任何對手都應該保持平衡",
        textEn: "Maintain GTO frequency - stay balanced against all opponents",
      },
      {
        key: "c",
        text: "增加 4bet bluff 頻率 - 對方會害怕",
        textEn: "Increase 4bet bluff frequency - opponent will be scared",
      },
      { key: "d", text: "只 flat call - 等翻後再打", textEn: "Just flat call - play postflop" },
    ],
    correctAnswer: "a",
    explanation:
      "跟注站的核心特徵是「不棄牌」。當你的 bluff 沒有 fold equity 時，最好的調整是移除範圍中的 bluff，專注於價值下注。ATs 對抗跟注站的 3bet call range 沒有足夠 equity 來持續 bluff。",
    explanationEn:
      "Calling stations' core trait is 'never folding'. When your bluffs have no fold equity, the best adjustment is to remove bluffs and focus on value betting. ATs doesn't have enough equity against a station's 3bet call range to continue bluffing.",
  },
  {
    id: "station_2",
    category: "station",
    categoryZh: "跟注站",
    categoryEn: "Calling Station",
    difficulty: "easy",
    question:
      "面對跟注站，你在翻牌圈拿著頂對頂 kicker。GTO 建議使用較大尺寸的下注，你應該如何調整？",
    questionEn:
      "Against a calling station, you have top pair top kicker on the flop. GTO suggests a larger bet size. How should you adjust?",
    options: [
      {
        key: "a",
        text: "使用更大的 sizing，甚至超池 - 他們會用更差的牌跟注",
        textEn: "Use even larger sizing, even overbet - they'll call with worse",
      },
      {
        key: "b",
        text: "使用較小的 sizing 來保護底池",
        textEn: "Use smaller sizing to protect the pot",
      },
      { key: "c", text: "過牌引誘對手下注", textEn: "Check to induce opponent's bet" },
      {
        key: "d",
        text: "維持 GTO sizing，不因對手調整",
        textEn: "Maintain GTO sizing, don't adjust",
      },
    ],
    correctAnswer: "a",
    explanation:
      "對跟注站最大化價值的關鍵是「用更大的 sizing 榨取」。他們會用任何對子、聽牌甚至高牌跟注，所以你的價值牌應該下更大的注來最大化長期 EV。",
    explanationEn:
      "The key to maximizing value against stations is 'larger sizing to extract'. They'll call with any pair, draw, or even high cards, so your value hands should bet bigger to maximize long-term EV.",
  },
  // Nit
  {
    id: "nit_1",
    category: "nit",
    categoryZh: "緊弱型",
    categoryEn: "Nit",
    difficulty: "medium",
    question: "Nit 型對手在 UTG 開牌。GTO 建議你在 BTN 用 AJo 3bet，你應該如何調整？",
    questionEn:
      "A Nit player opens from UTG. GTO suggests 3betting AJo on BTN. How should you adjust?",
    options: [
      {
        key: "a",
        text: "改為棄牌 - Nit 的 UTG 範圍極強，AJo 被壓制",
        textEn: "Fold instead - Nit's UTG range is very strong, AJo is dominated",
      },
      {
        key: "b",
        text: "3bet for value - Nit 會用弱牌棄牌給我們",
        textEn: "3bet for value - Nit will fold weak hands",
      },
      { key: "c", text: "維持 GTO 3bet 頻率", textEn: "Maintain GTO 3bet frequency" },
      {
        key: "d",
        text: "增加 3bet 頻率來剝削他的緊",
        textEn: "Increase 3bet frequency to exploit their tightness",
      },
    ],
    correctAnswer: "a",
    explanation:
      "Nit 的特徵是「只玩超強牌」。當 Nit 在 UTG 開牌，他的範圍可能只有 QQ+/AK。AJo 對這個範圍處於嚴重劣勢（常被 AK/AQ 壓制），應該直接棄牌而非 3bet。",
    explanationEn:
      "Nits' trait is 'only playing premium hands'. When a Nit opens UTG, their range might only be QQ+/AK. AJo is at a severe disadvantage against this range (often dominated by AK/AQ), so fold rather than 3bet.",
  },
  {
    id: "nit_2",
    category: "nit",
    categoryZh: "緊弱型",
    categoryEn: "Nit",
    difficulty: "easy",
    question: "Nit 在翻牌圈 check-raise 你。GTO 建議有時候用頂對跟注，你應該如何調整？",
    questionEn:
      "A Nit check-raises you on the flop. GTO suggests sometimes calling with top pair. How should you adjust?",
    options: [
      {
        key: "a",
        text: "用頂對棄牌 - Nit 的 check-raise 幾乎總是暗三以上",
        textEn: "Fold top pair - Nit's check-raise is almost always sets or better",
      },
      {
        key: "b",
        text: "跟注繼續 - 維持 GTO 頻率",
        textEn: "Call to continue - maintain GTO frequency",
      },
      { key: "c", text: "4bet 回擊來測試他", textEn: "4bet to test them" },
      {
        key: "d",
        text: "用任何對子跟注 - 他可能在 bluff",
        textEn: "Call with any pair - they might be bluffing",
      },
    ],
    correctAnswer: "a",
    explanation:
      "Nit 的 check-raise 範圍通常極度價值導向，幾乎沒有 bluff。當一個「從不 bluff」的人 check-raise 你時，即使是頂對也應該棄牌，因為你幾乎總是落後於暗三、兩對等強牌。",
    explanationEn:
      "Nit's check-raise range is typically extremely value-heavy with almost no bluffs. When someone who 'never bluffs' check-raises you, even top pair should fold because you're almost always behind sets, two pairs, etc.",
  },
  // Aggro Fish
  {
    id: "aggro_fish_1",
    category: "aggro_fish",
    categoryZh: "激進魚",
    categoryEn: "Aggro Fish",
    difficulty: "medium",
    question:
      "面對「激進魚」型對手，你持有 KK 在 BTN 開牌，他在 BB 3bet 到 4x。GTO 建議 4bet，你應該如何調整？",
    questionEn:
      "Against an 'Aggro Fish', you have KK on BTN and he 3bets 4x from BB. GTO suggests 4betting. How should you adjust?",
    options: [
      {
        key: "a",
        text: "Flat call 設陷阱 - 讓他翻後繼續 spew",
        textEn: "Flat call to trap - let them spew postflop",
      },
      {
        key: "b",
        text: "4bet 到全下 - 讓他用垃圾牌跟注",
        textEn: "4bet all-in - let them call with garbage",
      },
      { key: "c", text: "維持正常 4bet sizing", textEn: "Maintain normal 4bet sizing" },
      { key: "d", text: "直接棄牌避免 variance", textEn: "Just fold to avoid variance" },
    ],
    correctAnswer: "a",
    explanation:
      "激進魚會用過寬的範圍 3bet，但面對 4bet 可能棄掉大部分垃圾牌。用 KK flat call 可以讓他在翻後繼續用差牌下注，最大化你的價值。4bet 反而可能讓他棄掉你想要他繼續的手牌。",
    explanationEn:
      "Aggro fish 3bet with overly wide ranges but may fold most garbage to 4bets. Flat calling KK lets them continue betting worse hands postflop, maximizing your value. 4betting might fold out hands you want them to continue with.",
  },
  {
    id: "aggro_fish_2",
    category: "aggro_fish",
    categoryZh: "激進魚",
    categoryEn: "Aggro Fish",
    difficulty: "medium",
    question:
      "激進魚在翻牌圈領先下注（donk bet）1/3 底池。GTO 建議以一定頻率 bluff raise，你應該如何調整？",
    questionEn:
      "An aggro fish donk bets 1/3 pot on the flop. GTO suggests bluff raising at some frequency. How should you adjust?",
    options: [
      {
        key: "a",
        text: "減少 bluff raise - 他們可能會用任何牌 3bet 回來",
        textEn: "Reduce bluff raises - they might 3bet back with anything",
      },
      {
        key: "b",
        text: "增加 bluff raise 頻率 - 他們下注範圍弱",
        textEn: "Increase bluff raise frequency - their betting range is weak",
      },
      { key: "c", text: "維持 GTO raise 頻率", textEn: "Maintain GTO raise frequency" },
      { key: "d", text: "只用堅果牌 raise", textEn: "Only raise with nuts" },
    ],
    correctAnswer: "a",
    explanation:
      "激進魚的特點是「愛打不愛棄」。對他們的 donk bet bluff raise 很危險，因為他們可能用任何牌 3bet 回來或跟注。對激進玩家，減少 bluff 頻率，專注於用強牌 raise for value。",
    explanationEn:
      "Aggro fish's trait is 'likes to bet, doesn't like to fold'. Bluff raising their donk bets is risky because they might 3bet back or call with anything. Against aggressive players, reduce bluff frequency and focus on value raising with strong hands.",
  },
  // Honest Player (ABC)
  {
    id: "honest_1",
    category: "honest",
    categoryZh: "誠實型",
    categoryEn: "Honest/ABC",
    difficulty: "easy",
    question:
      "誠實型（ABC）玩家在河牌下注 full pot。GTO 建議以一定頻率 bluff-catch，你應該如何調整？",
    questionEn:
      "An honest/ABC player bets full pot on the river. GTO suggests bluff-catching at some frequency. How should you adjust?",
    options: [
      {
        key: "a",
        text: "更多棄牌 - 誠實玩家的大注幾乎都是價值牌",
        textEn: "Fold more - honest players' big bets are almost always value",
      },
      { key: "b", text: "維持 GTO bluff-catch 頻率", textEn: "Maintain GTO bluff-catch frequency" },
      {
        key: "c",
        text: "增加跟注頻率 - 他們在 bluff",
        textEn: "Increase call frequency - they're bluffing",
      },
      { key: "d", text: "raise 他們來測試", textEn: "Raise to test them" },
    ],
    correctAnswer: "a",
    explanation:
      "誠實/ABC 玩家的特點是「強牌打強，弱牌放棄」。當他們在河牌下大注時，很可能是價值牌。他們的 bluff 頻率遠低於 GTO 要求，所以你應該比 GTO 建議更多棄牌。",
    explanationEn:
      "Honest/ABC players' trait is 'bet strong with strong, give up with weak'. When they bet big on the river, it's likely value. Their bluff frequency is far below GTO requirements, so you should fold more than GTO suggests.",
  },
  // Rake Aware
  {
    id: "rake_1",
    category: "rake",
    categoryZh: "Rake 感知",
    categoryEn: "Rake Aware",
    difficulty: "hard",
    question:
      "在 10% rake 的環境中，你面對一個邊緣 3bet bluff 機會。在 5% rake 環境這是正 EV 的打法。你應該如何調整？",
    questionEn:
      "In a 10% rake environment, you face a marginal 3bet bluff opportunity. This play is +EV in 5% rake. How should you adjust?",
    options: [
      {
        key: "a",
        text: "改為棄牌 - 高 rake 讓邊緣 bluff 變成負 EV",
        textEn: "Fold instead - high rake makes marginal bluffs -EV",
      },
      {
        key: "b",
        text: "維持原有策略 - rake 不影響翻前策略",
        textEn: "Maintain strategy - rake doesn't affect preflop",
      },
      {
        key: "c",
        text: "使用更大的 sizing 來彌補 rake",
        textEn: "Use larger sizing to compensate for rake",
      },
      {
        key: "d",
        text: "增加 bluff 頻率以彌補損失",
        textEn: "Increase bluff frequency to make up losses",
      },
    ],
    correctAnswer: "a",
    explanation:
      "高 rake 環境（如 10%）直接削減你贏得底池時的淨利。邊緣 +EV 的打法在高 rake 下可能變成 -EV。正確的調整是收緊範圍，移除邊緣 bluff，專注於更強的價值打法。",
    explanationEn:
      "High rake environments (like 10%) directly cut your net profit when winning pots. Marginally +EV plays can become -EV in high rake. The correct adjustment is to tighten ranges, remove marginal bluffs, and focus on stronger value plays.",
  },
  {
    id: "rake_2",
    category: "rake",
    categoryZh: "Rake 感知",
    categoryEn: "Rake Aware",
    difficulty: "medium",
    question: "在高 rake 環境中，多人底池 vs 單挑底池哪個更有利？",
    questionEn: "In high rake environments, are multiway pots or heads-up pots more favorable?",
    options: [
      {
        key: "a",
        text: "單挑底池更有利 - 多人底池的 rake 成本分攤後對每個人都不利",
        textEn: "HU pots are better - multiway pot rake costs hurt everyone",
      },
      {
        key: "b",
        text: "多人底池更有利 - 贏更多能彌補 rake",
        textEn: "Multiway pots are better - winning more compensates rake",
      },
      { key: "c", text: "沒有區別", textEn: "No difference" },
      { key: "d", text: "取決於對手類型", textEn: "Depends on opponent types" },
    ],
    correctAnswer: "a",
    explanation:
      "在高 rake 環境中，單挑底池更有利。多人底池看似贏得更多，但高 rake 會削減更大比例的利潤。此外，多人底池的實現 equity 較低，combined 起來讓多人底池在高 rake 下更不利。",
    explanationEn:
      "In high rake environments, heads-up pots are more favorable. Multiway pots seem to win more, but high rake cuts a larger proportion of profit. Additionally, multiway pots have lower equity realization, making them even worse in high rake.",
  },
];

type Category = "station" | "nit" | "aggro_fish" | "honest" | "rake";

interface Question {
  id: string;
  category: Category;
  categoryZh: string;
  categoryEn: string;
  difficulty: string;
  question: string;
  questionEn: string;
  options: { key: string; text: string; textEn: string }[];
  correctAnswer: string;
  explanation: string;
  explanationEn: string;
}

const CATEGORY_ICONS: Record<Category, React.ReactNode> = {
  station: <Target className="h-4 w-4" />,
  nit: <AlertTriangle className="h-4 w-4" />,
  aggro_fish: <AlertTriangle className="h-4 w-4 text-red-500" />,
  honest: <CheckCircle2 className="h-4 w-4 text-blue-500" />,
  rake: <Trophy className="h-4 w-4 text-yellow-500" />,
};

export default function ExploitQuizPage() {
  const t = useTranslations();
  const [question, setQuestion] = useState<Question | null>(null);
  const [selectedAnswer, setSelectedAnswer] = useState<string | null>(null);
  const [score, setScore] = useState({ correct: 0, total: 0 });
  const [category, setCategory] = useState<Category | "all">("all");
  const [usedQuestions, setUsedQuestions] = useState<Set<string>>(new Set());

  const { quizStats, recordQuizResult } = useQuizProgressStore();
  const { user } = useAuthStore();
  const cumulativeStats = quizStats.exploit;

  const getRandomQuestion = useCallback(() => {
    let available = EXPLOIT_QUESTIONS.filter((q) => !usedQuestions.has(q.id));

    if (category !== "all") {
      available = available.filter((q) => q.category === category);
    }

    // Reset if we've used all questions
    if (available.length === 0) {
      setUsedQuestions(new Set());
      available =
        category === "all"
          ? EXPLOIT_QUESTIONS
          : EXPLOIT_QUESTIONS.filter((q) => q.category === category);
    }

    const randomQ = available[Math.floor(Math.random() * available.length)];
    setUsedQuestions((prev) => new Set([...prev, randomQ.id]));
    return randomQ as Question;
  }, [category, usedQuestions]);

  const loadQuestion = useCallback(() => {
    const q = getRandomQuestion();
    setQuestion(q);
    setSelectedAnswer(null);
  }, [getRandomQuestion]);

  useEffect(() => {
    loadQuestion();
  }, []);

  // Reset when category changes
  useEffect(() => {
    setUsedQuestions(new Set());
    setScore({ correct: 0, total: 0 });
    const q = getRandomQuestion();
    setQuestion(q);
    setSelectedAnswer(null);
  }, [category]);

  const handleAnswer = async (key: string) => {
    if (selectedAnswer) return;

    setSelectedAnswer(key);
    const isCorrect = key === question?.correctAnswer;
    setScore((prev) => ({
      correct: prev.correct + (isCorrect ? 1 : 0),
      total: prev.total + 1,
    }));

    // Record to progress store
    if (question) {
      await recordQuizResult("exploit", question.category, isCorrect, user?.id);
    }
  };

  const accuracy = score.total > 0 ? Math.round((score.correct / score.total) * 100) : 0;

  if (!question) {
    return (
      <div className="container max-w-2xl py-8">
        <div className="flex items-center justify-center py-12">
          <RefreshCw className="text-muted-foreground h-8 w-8 animate-spin" />
        </div>
      </div>
    );
  }

  return (
    <div className="container max-w-2xl py-8">
      {/* Header */}
      <div className="mb-6">
        <h1 className="text-2xl font-bold">{t("quiz.exploit.title") || "Exploit Quiz"}</h1>
        <p className="text-muted-foreground">
          {t("quiz.exploit.description") || "Learn to adjust GTO strategy based on opponent types"}
        </p>
      </div>

      {/* Score */}
      <div className="mb-6 flex items-center justify-between">
        <div className="flex items-center gap-4">
          <Badge variant="outline" className="px-3 py-1 text-lg">
            <Trophy className="mr-1 h-4 w-4" />
            {score.correct}/{score.total}
          </Badge>
          <span className="text-muted-foreground">{accuracy}%</span>
          {cumulativeStats.total > 0 && (
            <span className="text-muted-foreground text-xs">
              ({t("drill.allTime")}: {cumulativeStats.correct}/{cumulativeStats.total})
            </span>
          )}
        </div>
        <select
          className="bg-muted rounded-md px-3 py-1.5 text-sm"
          value={category}
          onChange={(e) => setCategory(e.target.value as Category | "all")}
        >
          <option value="all">{t("quiz.allCategories")}</option>
          <option value="station">跟注站 (Calling Station)</option>
          <option value="nit">緊弱型 (Nit)</option>
          <option value="aggro_fish">激進魚 (Aggro Fish)</option>
          <option value="honest">誠實型 (Honest/ABC)</option>
          <option value="rake">Rake 感知 (Rake Aware)</option>
        </select>
      </div>

      {/* Question Card */}
      <Card className="mb-6">
        <CardHeader className="pb-2">
          <CardDescription className="flex items-center gap-2">
            <Badge
              variant={
                question.difficulty === "easy"
                  ? "default"
                  : question.difficulty === "medium"
                    ? "secondary"
                    : "destructive"
              }
              className="flex items-center gap-1"
            >
              {CATEGORY_ICONS[question.category as Category]}
              {question.categoryZh}
            </Badge>
          </CardDescription>
          <CardTitle className="text-lg leading-relaxed whitespace-pre-line">
            {question.question}
          </CardTitle>
        </CardHeader>
        <CardContent>
          {/* Options */}
          <div className="space-y-3">
            {question.options.map((option) => {
              const isSelected = selectedAnswer === option.key;
              const showResult = selectedAnswer !== null;
              const isCorrect = option.key === question.correctAnswer;

              return (
                <Button
                  key={option.key}
                  variant={
                    showResult
                      ? isCorrect
                        ? "default"
                        : isSelected
                          ? "destructive"
                          : "outline"
                      : "outline"
                  }
                  className={cn(
                    "h-auto w-full justify-start px-4 py-4 text-left whitespace-normal",
                    showResult && isCorrect && "bg-green-600 hover:bg-green-600",
                    showResult && isSelected && !isCorrect && "bg-red-600"
                  )}
                  onClick={() => handleAnswer(option.key)}
                  disabled={showResult}
                >
                  <span className="mr-2 flex-shrink-0 font-bold">{option.key.toUpperCase()}.</span>
                  <span className="flex-1">{option.text}</span>
                  {showResult && isCorrect && (
                    <CheckCircle2 className="ml-2 h-5 w-5 flex-shrink-0" />
                  )}
                  {showResult && isSelected && !isCorrect && (
                    <XCircle className="ml-2 h-5 w-5 flex-shrink-0" />
                  )}
                </Button>
              );
            })}
          </div>

          {/* Result */}
          {selectedAnswer && (
            <div className="mt-6">
              {selectedAnswer === question.correctAnswer ? (
                <p className="text-center font-medium text-green-500">
                  {t("drill.result.correct")}
                </p>
              ) : (
                <p className="text-center font-medium text-red-500">
                  {t("drill.result.incorrect")}
                </p>
              )}
              <div className="bg-muted/30 mt-3 rounded-lg p-4">
                <p className="text-sm whitespace-pre-line">{question.explanation}</p>
              </div>
              <div className="mt-4 text-center">
                <Button onClick={loadQuestion}>{t("drill.nextHand")}</Button>
              </div>
            </div>
          )}
        </CardContent>
      </Card>

      {/* Tips */}
      <Card>
        <CardHeader>
          <CardTitle className="text-lg">{t("quiz.exploit.tips") || "Exploit Tips"}</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="text-muted-foreground space-y-2 text-sm">
            <p>
              {t("quiz.exploit.tip1") ||
                "1. Calling Stations: Never bluff, always value bet bigger"}
            </p>
            <p>
              {t("quiz.exploit.tip2") ||
                "2. Nits: Fold marginal hands to their aggression, steal more"}
            </p>
            <p>
              {t("quiz.exploit.tip3") || "3. Aggro Fish: Trap with strong hands, reduce bluffs"}
            </p>
            <p>{t("quiz.exploit.tip4") || "4. High Rake: Tighten ranges, avoid marginal spots"}</p>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}
