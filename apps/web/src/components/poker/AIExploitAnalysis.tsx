// ============================================
// AI Opponent Exploit Analysis Component
// 對手剝削分析：顯示對各 AI 的戰績與剝削建議
// ============================================

"use client";

import { cn } from "@/lib/utils";
import type { AIOpponentStats, AIStyle } from "@/lib/poker/types";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Progress } from "@/components/ui/progress";
import { Target, TrendingUp, TrendingDown, AlertCircle, CheckCircle2 } from "lucide-react";

// ============================================
// Exploit Suggestions by AI Style
// ============================================

const EXPLOIT_SUGGESTIONS: Record<AIStyle, {
  name: string;
  nameZh: string;
  shouldDo: string[];
  shouldAvoid: string[];
}> = {
  GTO: {
    name: "GTO Bot",
    nameZh: "GTO 機器人",
    shouldDo: ["打平衡策略", "不需要特別調整", "專注自己的基本功"],
    shouldAvoid: ["過度剝削", "極端策略", "頻繁詐唬"],
  },
  LAG: {
    name: "LAG Larry",
    nameZh: "激進拉里",
    shouldDo: ["對他的 3-bet 更多 4-bet bluff", "在大底池等待價值", "用強牌 slow play"],
    shouldAvoid: ["跟注他的所有 bluff", "在小牌面 bluff 他", "輕易放棄邊緣牌"],
  },
  TAG: {
    name: "TAG Tony",
    nameZh: "緊凶東尼",
    shouldDo: ["尊重他的大下注", "在他 check 時偷底池", "頻繁偷盲"],
    shouldAvoid: ["用中等牌跟注大下注", "在他加注後詐唬", "過度 bluff-catch"],
  },
  Loose_Passive: {
    name: "Passive Pete",
    nameZh: "被動乙乙",
    shouldDo: ["用強牌 value bet 薄一點", "更多價值下注", "減少詐唬"],
    shouldAvoid: ["詐唬", "放棄邊緣價值下注", "過度 respect 他的 raise"],
  },
  Tight_Passive: {
    name: "Nit Nancy",
    nameZh: "緊縮南西",
    shouldDo: ["頻繁偷盲", "面對加注直接棄牌中等牌", "用位置壓制"],
    shouldAvoid: ["對他詐唬", "在大底池輕易跟注", "忽視他的 aggression"],
  },
  Maniac: {
    name: "Maniac Mike",
    nameZh: "瘋狂麥克",
    shouldDo: ["讓他先行動", "用強牌 trap", "擴大跟注範圍"],
    shouldAvoid: ["詐唬", "4-bet bluff", "輕易棄牌"],
  },
};

const AI_STYLE_COLORS: Record<AIStyle, string> = {
  GTO: "text-blue-400",
  LAG: "text-red-400",
  TAG: "text-green-400",
  Loose_Passive: "text-yellow-400",
  Tight_Passive: "text-purple-400",
  Maniac: "text-orange-400",
};

// ============================================
// Helper Functions
// ============================================

function getWinRate(stat: { handsPlayed: number; handsWon: number }): number {
  if (stat.handsPlayed === 0) return 0;
  return (stat.handsWon / stat.handsPlayed) * 100;
}

function getBBPerHand(stat: { handsPlayed: number; totalProfit: number }): number {
  if (stat.handsPlayed === 0) return 0;
  return stat.totalProfit / stat.handsPlayed;
}

function getExploitScore(stat: { handsPlayed: number; handsWon: number; totalProfit: number }): {
  score: number;
  level: "excellent" | "good" | "average" | "poor";
  description: string;
} {
  if (stat.handsPlayed < 20) {
    return { score: 0, level: "average", description: "需要更多手數" };
  }

  const bbPerHand = getBBPerHand(stat);

  if (bbPerHand >= 5) {
    return { score: 100, level: "excellent", description: "完美剝削" };
  } else if (bbPerHand >= 2) {
    return { score: 75, level: "good", description: "有效剝削" };
  } else if (bbPerHand >= 0) {
    return { score: 50, level: "average", description: "持平" };
  } else if (bbPerHand >= -2) {
    return { score: 25, level: "poor", description: "小幅虧損" };
  } else {
    return { score: 0, level: "poor", description: "被剝削" };
  }
}

// ============================================
// Sub Components
// ============================================

interface StyleStatCardProps {
  style: AIStyle;
  stat: { handsPlayed: number; handsWon: number; totalProfit: number };
  isExpanded?: boolean;
  onToggle?: () => void;
}

function StyleStatCard({ style, stat, isExpanded, onToggle }: StyleStatCardProps) {
  const info = EXPLOIT_SUGGESTIONS[style];
  const winRate = getWinRate(stat);
  const bbPerHand = getBBPerHand(stat);
  const exploit = getExploitScore(stat);

  const hasData = stat.handsPlayed >= 5;

  return (
    <div
      className={cn(
        "rounded-lg border p-3 transition-all cursor-pointer hover:border-white/30",
        isExpanded ? "border-white/40 bg-white/5" : "border-white/10"
      )}
      onClick={onToggle}
    >
      {/* Header */}
      <div className="flex items-center justify-between mb-2">
        <div className="flex items-center gap-2">
          <span className={cn("font-semibold", AI_STYLE_COLORS[style])}>
            {info.nameZh}
          </span>
          <Badge variant="outline" className="text-xs">
            {stat.handsPlayed} 手
          </Badge>
        </div>
        {hasData && (
          <div className="flex items-center gap-1">
            {bbPerHand >= 0 ? (
              <TrendingUp className="h-4 w-4 text-green-400" />
            ) : (
              <TrendingDown className="h-4 w-4 text-red-400" />
            )}
            <span
              className={cn(
                "text-sm font-mono",
                bbPerHand >= 0 ? "text-green-400" : "text-red-400"
              )}
            >
              {bbPerHand >= 0 ? "+" : ""}{bbPerHand.toFixed(1)} BB/手
            </span>
          </div>
        )}
      </div>

      {/* Stats */}
      {hasData ? (
        <div className="space-y-2">
          <div className="flex justify-between text-xs text-gray-400">
            <span>勝率</span>
            <span>{winRate.toFixed(1)}%</span>
          </div>
          <Progress value={winRate} className="h-1.5" />

          <div className="flex justify-between text-xs">
            <span className="text-gray-400">剝削效率</span>
            <span
              className={cn(
                exploit.level === "excellent" && "text-green-400",
                exploit.level === "good" && "text-blue-400",
                exploit.level === "average" && "text-yellow-400",
                exploit.level === "poor" && "text-red-400"
              )}
            >
              {exploit.description}
            </span>
          </div>
        </div>
      ) : (
        <p className="text-xs text-gray-500">需要至少 5 手數據</p>
      )}

      {/* Expanded Suggestions */}
      {isExpanded && hasData && (
        <div className="mt-3 pt-3 border-t border-white/10 space-y-2">
          <div>
            <p className="text-xs text-green-400 font-semibold flex items-center gap-1 mb-1">
              <CheckCircle2 className="h-3 w-3" /> 應該做
            </p>
            <ul className="text-xs text-gray-300 space-y-1 pl-4">
              {info.shouldDo.map((item, i) => (
                <li key={i} className="list-disc">{item}</li>
              ))}
            </ul>
          </div>
          <div>
            <p className="text-xs text-red-400 font-semibold flex items-center gap-1 mb-1">
              <AlertCircle className="h-3 w-3" /> 應該避免
            </p>
            <ul className="text-xs text-gray-300 space-y-1 pl-4">
              {info.shouldAvoid.map((item, i) => (
                <li key={i} className="list-disc">{item}</li>
              ))}
            </ul>
          </div>
        </div>
      )}
    </div>
  );
}

// ============================================
// Main Component
// ============================================

interface AIExploitAnalysisProps {
  stats: AIOpponentStats;
  minHandsRequired?: number;
  className?: string;
}

export function AIExploitAnalysis({
  stats,
  minHandsRequired = 20,
  className,
}: AIExploitAnalysisProps) {
  // Calculate total hands against AI
  const totalHands = Object.values(stats.byStyle).reduce(
    (sum, stat) => sum + stat.handsPlayed,
    0
  );

  // Find most profitable and least profitable styles
  const styleEntries = Object.entries(stats.byStyle) as [AIStyle, typeof stats.byStyle.GTO][];
  const sortedStyles = styleEntries
    .filter(([_, stat]) => stat.handsPlayed >= 5)
    .sort((a, b) => getBBPerHand(b[1]) - getBBPerHand(a[1]));

  const bestStyle = sortedStyles[0];
  const worstStyle = sortedStyles[sortedStyles.length - 1];

  // Get expanded state
  const [expandedStyle, setExpandedStyle] = React.useState<AIStyle | null>(null);

  return (
    <div className={cn("space-y-4", className)}>
      {/* Header */}
      <div className="flex items-center gap-2">
        <Target className="h-5 w-5 text-purple-400" />
        <h3 className="font-semibold">對手剝削分析</h3>
        <Badge variant="secondary" className="text-xs">
          {totalHands} 手
        </Badge>
      </div>

      {/* Not enough data */}
      {totalHands < minHandsRequired ? (
        <div className="text-center py-4 text-gray-400">
          <p>需要更多對戰數據</p>
          <p className="text-xs">
            {totalHands} / {minHandsRequired} 手
          </p>
          <Progress
            value={(totalHands / minHandsRequired) * 100}
            className="h-2 mt-2 max-w-xs mx-auto"
          />
        </div>
      ) : (
        <>
          {/* Summary */}
          <div className="grid grid-cols-2 gap-2 text-sm">
            {bestStyle && (
              <div className="bg-green-900/20 border border-green-500/30 rounded-lg p-2">
                <p className="text-xs text-green-400">最佳剝削</p>
                <p className={cn("font-semibold", AI_STYLE_COLORS[bestStyle[0]])}>
                  {EXPLOIT_SUGGESTIONS[bestStyle[0]].nameZh}
                </p>
                <p className="text-xs text-green-300">
                  +{getBBPerHand(bestStyle[1]).toFixed(1)} BB/手
                </p>
              </div>
            )}
            {worstStyle && sortedStyles.length > 1 && (
              <div className="bg-red-900/20 border border-red-500/30 rounded-lg p-2">
                <p className="text-xs text-red-400">需要加強</p>
                <p className={cn("font-semibold", AI_STYLE_COLORS[worstStyle[0]])}>
                  {EXPLOIT_SUGGESTIONS[worstStyle[0]].nameZh}
                </p>
                <p className="text-xs text-red-300">
                  {getBBPerHand(worstStyle[1]).toFixed(1)} BB/手
                </p>
              </div>
            )}
          </div>

          {/* Style Stats */}
          <div className="space-y-2">
            {(Object.entries(stats.byStyle) as [AIStyle, typeof stats.byStyle.GTO][]).map(
              ([style, stat]) => (
                <StyleStatCard
                  key={style}
                  style={style}
                  stat={stat}
                  isExpanded={expandedStyle === style}
                  onToggle={() =>
                    setExpandedStyle(expandedStyle === style ? null : style)
                  }
                />
              )
            )}
          </div>
        </>
      )}
    </div>
  );
}

// Need to import React for useState
import React from "react";

export default AIExploitAnalysis;
